---
import Layout from '@/layouts/Layout.astro';
import { actions } from 'astro:actions';
import { isInputError } from 'astro:actions';
import { generateCSRFToken } from '@/utils/csrf';
import ContactForm from '@/components/contactForm/ContactForm.astro';
import HomeServices from '@/components/services/HomeServices.astro';
import Testimonials from '@/components/testimonials/Testimonials.astro';
import Sentences from '@/components/sentences/Sentences.astro';
import Image from '@/components/image/Image.astro';
import type { Page } from '@/payloadTypes';
import RichText from '@/components/RichText/RichText.astro';
import { getPageBySlug } from '@/utils/payloadFetch';
import BreadcrumbSchema from '@/components/SEO/BreadcrumbSchema.astro';
import OrganizationSchema from '@/components/SEO/OrganizationSchema.astro';
import WebPageSchema from '@/components/SEO/WebPageSchema.astro';
const currentLang = 'eu';
const page: Page | null = await getPageBySlug('sarrera', 'eu');

if (!page && Astro.url.pathname !== '/eu/') {
	return Astro.redirect('/eu/');
}

const breadcrumbs = [
	{
		name: currentLang === 'eu' ? 'Inicio' : 'Hasiera',
		url: Astro.url.pathname,
	},
];

const seoTitle =
	page.meta?.title ||
	'Aitama Sleep Coaching | Lo Haur Infantilaren Aholkularitza';
const seoDescription =
	page.meta?.description ||
	'Familiei gau lasaiak lortzen laguntzen diet metodo errespetuzkoekin';
const seoImage =
	page.meta?.image?.unpicUrl ||
	'https://aitamasleepcoaching.com/img/banner.png';

const heroImage =
	page.hero && 'media' in page.hero && page.hero.media
		? typeof page.hero.media === 'object'
			? page.hero.media
			: null
		: null;

const preloadImages = [
	heroImage?.unpicUrl,
	page.layout[1]?.media?.unpicUrl,
].filter(Boolean);

const result = Astro.getActionResult(actions.send);
const inputErrors = isInputError(result?.error) ? result?.error.fields : {};

const csrf = generateCSRFToken();
Astro.cookies.set('csrf_token', csrf, {
	path: '/',
	httpOnly: true,
	sameSite: 'strict',
	secure: true,
});

if (result?.data) {
	return Astro.redirect(`/${currentLang}/?sent=true`);
}
---

<Layout
	title={seoTitle}
	description={seoDescription}
	ogImage={seoImage}
	lang={currentLang}
	preloadImages={preloadImages}
>
	<OrganizationSchema
		slot="head"
		description={seoDescription}
		locale={currentLang}
	/>

	<WebPageSchema
		slot="head"
		title={seoTitle}
		description={seoDescription}
		image={seoImage}
	/>

	<BreadcrumbSchema slot="head" items={breadcrumbs} />

	<section>
		<div
			class="hero-image bg-home"
			style={`background-image: url(${heroImage?.unpicUrl})`}
			role="img"
			aria-label={page.hero.title}
		>
			<div class="hero-image__overlay"></div>
			<div class="hero-image__info">
				<div class="hero-image__text hero-heading">
					<p tabindex="0">Alazne naiz</p>
					<h1>{page.hero.title}</h1>
				</div>
				{
					page?.hero?.links?.map((link) => (
						<a
							href="#contact"
							class="btn"
							aria-label={`${link.link.label} - Jarri harremanetan`}
						>
							{link.link.label}
						</a>
					))
				}
			</div>
		</div>
	</section>

	<section class="h-intro wrapper" aria-labelledby="intro-heading">
		<div class="paragraph u-margin-top-8">
			<h2 id="intro-heading" class="heading-secondary" tabindex="0">
				{page.layout[0].title}
			</h2>
			<RichText content={page.layout[0].richText} />
		</div>
		<div class="h-intro__img">
			<Image
				src={page.layout[1].media.unpicUrl}
				alt={page.layout[1].media.alt || ''}
				layout="constrained"
				priority={false}
				cdn="cloudinary"
			/>
		</div>
	</section>

	<section class="h-services wrapper" aria-labelledby="services-heading">
		<p class="heading-title" tabindex="0">{page.layout[2].sectionTitle}</p>
		<h2 id="services-heading" class="heading-secondary" tabindex="0">
			{page.layout[2].title}
		</h2>
		<div class="paragraph"><RichText content={page.layout[2].richText} /></div>
		<HomeServices services={page.layout[3].services} />
	</section>

	<section class="h-job" aria-labelledby="job-heading">
		<div class="wrapper">
			<p class="heading-title" tabindex="0">{page.layout[4].sectionTitle}</p>
			<h2 id="job-heading" class="heading-secondary" tabindex="0">
				{page.layout[4].title}
			</h2>
			<div class="paragraph animated">
				<RichText content={page.layout[4].richText} />
				<a
					href="#contact"
					class="btn btn-section animated cta-btn"
					aria-label="Jarri harremanetan - Kontaktu formularioa"
				>
					Jarri Harremanetan
				</a>
			</div>
		</div>
		<div class="h-job__img">
			<Image
				src={page.layout[5].media.unpicUrl}
				width={480}
				height={480}
				alt={page.layout[5].media.alt || ''}
				layout="constrained"
				priority={false}
				cdn="cloudinary"
			/>
		</div>
	</section>

	<Testimonials opinions={page.layout[6]} />
	<Sentences sentences={page.layout[7].sentences} />
	<ContactForm inputErrors={inputErrors} csrf={csrf} />
</Layout>

<style>
	.hero-image {
		position: relative;
		min-height: 100vh;
		background-size: cover;
		background-position: center;
		background-repeat: no-repeat;
	}

	.hero-image__overlay {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.3);
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const options = { threshold: 0.05, rootMargin: '0px 0px -10% 0px' };
		const animatedItems = document.querySelectorAll('.animated-2');

		if (!('IntersectionObserver' in window)) {
			animatedItems.forEach((el) => el.classList.add('slide-in-right'));
			return;
		}

		const observer = new IntersectionObserver((entries) => {
			entries.forEach((entry, index) => {
				if (
					entry.isIntersecting &&
					entry.target instanceof HTMLElement &&
					!entry.target.classList.contains('slide-in-right')
				) {
					entry.target.style.animationDelay = `${index * 100}ms`;
					entry.target.classList.add('slide-in-right');
					observer.unobserve(entry.target);
				}
			});
		}, options);

		animatedItems.forEach((item) => observer.observe(item));

		if (!('loading' in HTMLImageElement.prototype)) {
			const imageObserver = new IntersectionObserver((entries) => {
				entries.forEach((entry) => {
					if (
						entry.isIntersecting &&
						entry.target instanceof HTMLImageElement
					) {
						const img = entry.target;
						img.src = img.dataset.src || img.src;
						img.classList.remove('lazy');
						imageObserver.unobserve(img);
					}
				});
			});
			document
				.querySelectorAll('img.lazy')
				.forEach((img) => imageObserver.observe(img));
		}
	});
</script>
