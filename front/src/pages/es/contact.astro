---
import SuccessContactPopup from '@/components/pop-ups/SuccessContactPopup.astro';
import Layout from '@/layouts/Layout.astro';
import { generateCSRFToken } from '@/utils/csrf';
import { actions, isInputError } from 'astro:actions';
import { getPageBySlug } from '@/utils/payloadFetch';
import type { Page, Media } from '@/payloadTypes';
import BreadcrumbSchema from '@/components/SEO/BreadcrumbSchema.astro';
import WebPageSchema from '@/components/SEO/WebPageSchema.astro';

const currentLang = Astro.currentLocale || 'es';
const page: Page | null = await getPageBySlug('contacto', 'es');

if (!page && Astro.url.pathname !== '/es/contact') {
	return Astro.redirect('/es/contact');
}

const breadcrumbs = [
	{
		name: currentLang === 'es' ? 'Contacto' : 'Kontaktua',
		url: Astro.url.pathname,
	},
];

const layoutImage =
	page?.layout[0]?.media && typeof page.layout[0].media === 'object'
		? page.layout[0].media
		: null;

const seoTitle = page.meta?.title || 'Sobre mí';
const seoDescription = page.meta?.description || 'Formulario de contacto';
const seoImage =
	page?.meta?.image?.unpicUrl ||
	'https://aitamasleepcoaching.com/img/banner.png';

const heroImage =
	page?.hero && 'media' in page.hero && page.hero.media
		? typeof page.hero.media === 'object'
			? page.hero.media
			: null
		: null;

const preloadImages = [
	heroImage?.unpicUrl,
	page?.layout[1]?.media?.unpicUrl,
	layoutImage?.unpicUrl,
].filter(Boolean);

const result = Astro.getActionResult(actions.send);
const inputErrors = isInputError(result?.error) ? result?.error.fields : {};

const csrf = generateCSRFToken();
Astro.cookies.set('csrf_token', csrf, {
	path: '/',
	httpOnly: true,
	sameSite: 'strict',
	secure: true,
});

if (result?.data) {
	return Astro.redirect(`/${currentLang}/contact/?sent=true`);
}

// ✅ Variable correcta
const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
---

<Layout
	title={seoTitle}
	description={seoDescription}
	ogImage={seoImage}
	lang={currentLang}
	preloadImages={preloadImages}
>
	<WebPageSchema
		slot="head"
		title={seoTitle}
		description={seoDescription}
		image={seoImage}
	/>
	<BreadcrumbSchema slot="head" items={breadcrumbs} />

	<section>
		<div
			class="hero-image bg-contact"
			style={`
				min-height: 37vh;
				${layoutImage?.unpicUrl ? `background-image: url(${heroImage?.unpicUrl});` : ''}
			`}
		>
		</div>

		<div id="contact"></div>

		<section class="h-contact h-contact-page">
			<div
				class="h-contact-page__col1"
				style={page.layout[0]?.media?.unpicUrl
					? `background-image: url('${page.layout[0].media.unpicUrl}')`
					: ''}
			>
			</div>

			<div class="h-contact-page__col2">
				<div class="wrapper" style="margin-top: 3rem;">
					<p class="heading-title" tabindex="0">Contacto</p>
					<h2 class="heading-secondary animated fadeInUp" tabindex="0">
						Formulario de contacto
					</h2>
					<div class="paragraph animated u-text-align-center fadeInUp">
						<p tabindex="0">¡Ponte en contacto conmigo y hablamos!</p>
					</div>
				</div>

				<form
					id="contactPageForm"
					class="h-contact__form h-contact-page__form"
					action={actions.send}
					method="POST"
				>
					<div class="h-contact-page__field">
						<label class="h-contact-page__label" for="contactPageName">
							¿Cómo te llamas?
						</label>
						<input type="text" id="contactPageName" name="username" required />
						<span id="error-name" style="color:#eb374d">
							{inputErrors.username}
						</span>
					</div>

					<div class="h-contact-page__field">
						<label class="h-contact-page__label" for="contactPageEmail">
							Email
						</label>
						<input type="email" id="contactPageEmail" name="email" required />
						<span id="error-email" style="color:#eb374d">
							{inputErrors.email}
						</span>
					</div>

					<div class="h-contact-page__field">
						<label class="h-contact-page__label" for="contactPageSelect">
							Selecciona un asunto:
						</label>
						<select name="select" id="contactPageSelect">
							<option value="" selected></option>
							<option value="Plan de sueño personalizado con seguimiento">
								Plan de sueño personalizado con seguimiento
							</option>
							<option value="Plan a vuestro ritmo">Plan a vuestro ritmo</option>
							<option value="Consultas">Consultas</option>
							<option value="Encuentros grupales">Encuentros grupales</option>
							<option value="Plan de sueño conmigo pero a tu ritmo">
								Plan de sueño conmigo pero a tu ritmo
							</option>
						</select>
						<span id="error-reason" style="color:#eb374d">
							{inputErrors.select}
						</span>
					</div>

					<div class="h-contact-page__field">
						<label class="h-contact-page__label" for="contactPageMessage">
							Mensaje
						</label>
						<textarea
							id="contactPageMessage"
							name="message"
							cols="40"
							rows="10"
							required></textarea>
						<span id="error-message" style="color:#eb374d">
							{inputErrors.message}
						</span>
					</div>

					<input type="hidden" name="lang" value={currentLang} />
					<input type="hidden" id="csrf_token" name="csrf_token" value={csrf} />
					<input type="hidden" id="cfTurnstileToken" name="cfTurnstileToken" />

					<div
						class="cf-turnstile"
						data-sitekey={TURNSTILE_SITE_KEY}
						data-theme="light"
						data-size="normal"
						data-callback="onTurnstileSuccess"
						data-error-callback="onTurnstileError"
						data-expired-callback="onTurnstileExpired"
					>
					</div>

					<button
						id="contactPageBtn"
						class="btn btn-section animated h-contact__btn"
						style="z-index: 0; margin-top: 1rem;"
						type="submit"
						disabled>Enviar</button
					>

					<div class="h-contact__footer">
						<input
							id="contactPageTerms"
							type="checkbox"
							name="termsAccepted"
							required
							aria-label="Aceptar terminos"
						/>
						<p style="font-size: .9rem; line-height:1.2; margin-top:1rem;">
							Todos los datos aportados por el usuario en este formulario NO
							tendrán persistencia en ninguna base de datos ni en ningún otro
							sistema de persistencia.
						</p>
					</div>
					<span id="error-terms" style="color:#eb374d">
						{inputErrors.termsAccepted}
					</span>
				</form>

				<SuccessContactPopup />
			</div>
		</section>
	</section>

	<script is:inline>
		document.addEventListener('DOMContentLoaded', () => {
			const form = document.getElementById('contactPageForm');
			const submitBtn = document.getElementById('contactPageBtn');
			const tokenInput = document.getElementById('cfTurnstileToken');

			const fields = {
				name: {
					input: document.getElementById('contactPageName'),
					error: document.getElementById('error-name'),
					validate: (v) => {
						const len = v.trim().length;
						if (!len) return 'El nombre es obligatorio';
						if (len <= 2) return 'El nombre debe tener al menos 3 caracteres';
						if (len > 50) return 'El nombre no debe superar 50 caracteres';
						return true;
					},
				},
				email: {
					input: document.getElementById('contactPageEmail'),
					error: document.getElementById('error-email'),
					validate: (v) =>
						/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v) || 'Email no válido',
				},
				reason: {
					input: document.getElementById('contactPageSelect'),
					error: document.getElementById('error-reason'),
					validate: (v) => v !== '' || 'Selecciona un motivo',
				},
				message: {
					input: document.getElementById('contactPageMessage'),
					error: document.getElementById('error-message'),
					validate: (v) =>
						v.trim().length >= 10 || 'Mensaje muy corto (mín. 10 caracteres)',
				},
				terms: {
					input: document.getElementById('contactPageTerms'),
					error: document.getElementById('error-terms'),
					validate: (v, input) => input.checked || 'Debes aceptar los términos',
				},
			};

			function validateAll() {
				let valid = true;
				Object.values(fields).forEach(({ input, error, validate }) => {
					const value = input.type === 'checkbox' ? input.checked : input.value;
					const result = validate(value, input);
					if (result !== true) {
						error.textContent = result;
						input.classList.add('invalid');
						valid = false;
					} else {
						error.textContent = '';
						input.classList.remove('invalid');
					}
				});

				const hasToken = tokenInput && tokenInput.value.trim() !== '';
				submitBtn.disabled = !(valid && hasToken);

				return valid && hasToken;
			}

			Object.values(fields).forEach(({ input }) => {
				input.addEventListener('input', validateAll);
				input.addEventListener('change', validateAll);
			});

			form.addEventListener('submit', (e) => {
				if (!validateAll()) e.preventDefault();
			});

			window.onTurnstileSuccess = (token) => {
				console.log('✅ Turnstile verificado');
				tokenInput.value = token;
				validateAll();
			};

			window.onTurnstileError = () => {
				console.error('❌ Error en Turnstile');
				tokenInput.value = '';
				validateAll();
			};

			window.onTurnstileExpired = () => {
				console.warn('⚠️ Turnstile expirado');
				tokenInput.value = '';
				validateAll();
			};
		});
	</script>
</Layout>
