---
import Layout from '@/layouts/Layout.astro';
import ContactForm from '@/components/contactForm/ContactForm.astro';
import ServiceForm from '@/components/serviceForm/ServiceForm.astro';
import ServicesPage from '@/components/services/ServicesPage.astro';
import CldImage from '@/components/image/Image.astro';
import RichText from '@/components/RichText/RichText.astro';
import BreadcrumbSchema from '@/components/SEO/BreadcrumbSchema.astro';
import WebPageSchema from '@/components/SEO/WebPageSchema.astro';
import { actions, isInputError } from 'astro:actions';
import { generateCSRFToken } from '@/utils/csrf';
import { getPageBySlug } from '@/utils/payloadFetch';
import type { Page } from '@/payloadTypes';
export const prerender = true;
const currentLang = Astro.currentLocale || 'es';
const page: Page | null = await getPageBySlug('servicios', 'es');

if (!page) {
	return Astro.redirect(currentLang === 'es' ? '/es/services' : '/eu/services');
}

const breadcrumbs = [
	{
		name: currentLang === 'es' ? 'Servicios' : 'Zerbitzuak',
		url: Astro.url.pathname,
	},
];

const seoTitle = page.meta?.title || 'Servicios | Aitama Sleep Coaching';
const seoDescription =
	page.meta?.description ||
	'Descubre nuestros servicios de asesoría del sueño infantil.';
const seoImage =
	page.meta?.image?.unpicUrl ||
	'https://aitamasleepcoaching.com/img/banner.png';
const heroImage =
	page.hero?.media && typeof page.hero.media === 'object'
		? page.hero.media
		: null;

const preloadImages = [
	heroImage?.unpicUrl,
	page.layout[1]?.media?.unpicUrl,
].filter(Boolean);

const contactResult = Astro.getActionResult(actions.send);
const serviceResult = Astro.getActionResult(actions.sendContactEmail);

const contactInputErrors = isInputError(contactResult?.error)
	? contactResult.error.fields
	: {};
const serviceInputErrors = isInputError(serviceResult?.error)
	? serviceResult.error.fields
	: {};

const csrf = generateCSRFToken();
Astro.cookies.set('csrf_token', csrf, {
	path: '/',
	httpOnly: true,
	sameSite: 'strict',
	secure: true,
});

if (contactResult?.data || serviceResult?.data) {
	return Astro.redirect(`/${currentLang}/services/?sent=true`);
}
---

<Layout
	title={seoTitle}
	description={seoDescription}
	ogImage={seoImage}
	lang={currentLang}
	preloadImages={preloadImages}
>
	<WebPageSchema
		slot="head"
		title={seoTitle}
		description={seoDescription}
		image={seoImage}
	/>
	<BreadcrumbSchema slot="head" items={breadcrumbs} />

	<section>
		<div
			class="hero-image bg-service"
			style={`background-image: url(${heroImage?.unpicUrl})`}
			role="img"
			aria-label={page.hero.title}
		>
			<div class="hero-image__overlay"></div>
			<div class="hero-image__info service-box-info">
				<div class="hero-image__text service-text">
					<p tabindex="0">
						{currentLang === 'es' ? 'Servicios' : 'Zerbitzuak'}
					</p>
					<h1 tabindex="0" class="service_heading">{page.hero.title}</h1>
					<p tabindex="0">{page.hero.text}</p>
					<small
						class="hero-image__small-text"
						style="margin-top:.5rem;color:#222;font-size:1rem;font-family:Montserrat,sans-serif;"
					>
						{page.hero.subtext}
					</small>
				</div>
				{
					page.hero.links?.map((link) => (
						<a
							href="#contact"
							class="btn service-button"
							aria-label={`${link.link.label} - ${currentLang === 'es' ? 'Contacta' : 'Jarri harremanetan'}`}
						>
							{link.link.label}
						</a>
					))
				}
			</div>
		</div>
	</section>

	<div id="mask" class="hidden"></div>

	<section class="h-services boxes-services">
		<p class="heading-title" tabindex="0">{page.layout[0].sectionTitle}</p>
		<h2 class="heading-secondary" tabindex="0">{page.layout[0].title}</h2>
		<ServicesPage services={page.layout[1].services} />
	</section>

	{
		page.layout.slice(2).map((service, index) => (
			<section id={`service-${index}`} class="h-services" key={index}>
				<div class="wrapper">
					<h2 class="heading-secondary animated" tabindex="0">
						{service.title}
					</h2>
					<div class="paragraph animated service-paragraph">
						<RichText content={service.richText} />
						{service.price && (
							<div
								class="services__price"
								itemprop="offers"
								itemscope
								itemtype="http://schema.org/Offer"
							>
								<span itemprop="priceCurrency">€</span>
								<span itemprop="price">{service.price}</span>
								<span>(IVA incluido)</span>
							</div>
						)}
						<div class="services__options">
							<a
								href="javascript:void(0)"
								class="btn btn-section js-modal"
								data-service={service.title}
							>
								{currentLang === 'es'
									? 'Llamada de valoración gratuita'
									: 'Balorazio deia doan'}
							</a>
						</div>
					</div>
				</div>
				{service.media?.unpicUrl && (
					<div class="h-job__img">
						<CldImage
							src={service.media.unpicUrl}
							width={400}
							height={service.media.height || 400}
							alt={service.media.alt || service.title}
						/>
					</div>
				)}
			</section>
		))
	}

	<div
		id="my-modal"
		class="modal"
		role="dialog"
		aria-modal="true"
		aria-labelledby="modal-title"
		style="display:none;"
	>
		<div
			class="modal-content"
			style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);margin:0"
		>
			<div class="modal-header">
				<span class="close" aria-label="Cerrar modal">×</span>
			</div>
			<div class="modal-body">
				<h2 id="modal-title" class="visually-hidden">
					{
						currentLang === 'es'
							? 'Formulario de Servicio'
							: 'Zerbitzu formularioa'
					}
				</h2>
				<ServiceForm inputErrors={serviceInputErrors} csrf={csrf} />
			</div>
		</div>
	</div>

	<ContactForm inputErrors={contactInputErrors} csrf={csrf} />
</Layout>

<style>
	.hero-image {
		position: relative;
		min-height: 100vh;
		background-size: cover;
		background-position: center;
		background-repeat: no-repeat;
	}
	.hero-image__overlay {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.3);
	}
	.modal {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.6);
		z-index: 999;
	}
	.modal-content {
		background: #fff;
		padding: 2rem;
		border-radius: 8px;
		max-width: 500px;
		width: 90%;
	}
	.close {
		cursor: pointer;
		font-size: 1.5rem;
	}
</style>

<script is:inline>
	document.addEventListener('DOMContentLoaded', () => {
		const modal = document.getElementById('my-modal');
		const input = document.getElementById('serviceInput');
		const closeBtn = modal?.querySelector('.close');

		document.querySelectorAll('.js-modal').forEach((btn) => {
			btn.addEventListener('click', (e) => {
				e.preventDefault();
				const serviceTitle = btn.dataset.service;
				if (input && serviceTitle) input.value = serviceTitle;
				if (modal) {
					modal.style.display = 'block';
					document.body.style.overflow = 'hidden';
				}
			});
		});

		modal?.addEventListener('click', (e) => {
			if (e.target === modal) {
				modal.style.display = 'none';
				document.body.style.overflow = '';
			}
		});

		closeBtn?.addEventListener('click', () => {
			if (modal) {
				modal.style.display = 'none';
				document.body.style.overflow = '';
			}
		});
	});
</script>
