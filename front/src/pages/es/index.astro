---
import Layout from '@/layouts/Layout.astro';
import { actions } from 'astro:actions';
import { isInputError } from 'astro:actions';
import { generateCSRFToken } from '@/utils/csrf';
import ContactForm from '@/components/contactForm/ContactForm.astro';
import HomeServices from '@/components/services/HomeServices.astro';
import Testimonials from '@/components/testimonials/Testimonials.astro';
import Sentences from '@/components/sentences/Sentences.astro';
import Image from '@/components/image/Image.astro';
import { getPageBySlug } from '@/utils/payloadFetch';
import type { Page } from '@/payloadTypes';
import RichText from '@/components/RichText/RichText.astro';
import BreadcrumbSchema from '@/components/SEO/BreadcrumbSchema.astro';
import OrganizationSchema from '@/components/SEO/OrganizationSchema.astro';
import WebPageSchema from '@/components/SEO/WebPageSchema.astro';
const currentLang = Astro.currentLocale || 'eu';

const page: Page | null = await getPageBySlug('inicio', 'es');

if (!page && Astro.url.pathname !== '/es/') {
	return Astro.redirect('/es/');
}

const seoTitle =
	page.meta?.title ||
	'Aitama Sleep Coaching | Asesoría del Sueño Infantil Personalizada';
const seoDescription =
	page.meta?.description ||
	'Ayudo a familias a conseguir noches tranquilas con métodos respetuosos. Asesoría del sueño infantil personalizada, sin llanto. Mejora el descanso de tu bebé hoy.';
const seoImage =
	page.meta?.image?.unpicUrl ||
	'https://aitamasleepcoaching.com/img/banner.png';

const heroImage =
	page.hero && 'media' in page.hero && page.hero.media
		? typeof page.hero.media === 'object'
			? page.hero.media
			: null
		: null;

const preloadImages = [
	heroImage?.unpicUrl,
	page.layout[1]?.media?.unpicUrl,
].filter(Boolean);

const result = Astro.getActionResult(actions.send);
const inputErrors = isInputError(result?.error) ? result?.error.fields : {};

const csrf = generateCSRFToken();
Astro.cookies.set('csrf_token', csrf, {
	path: '/',
	httpOnly: true,
	sameSite: 'strict',
	secure: true,
});

if (result?.data) {
	return Astro.redirect(`/${currentLang}/?sent=true`);
}

const breadcrumbs = [
	{
		name: currentLang === 'eu' ? 'Inicio' : 'Hasiera',
		url: Astro.url.pathname,
	},
];
---

<Layout
	title={seoTitle}
	description={seoDescription}
	ogImage={seoImage}
	lang={currentLang}
	preloadImages={preloadImages}
>
	<OrganizationSchema
		slot="head"
		description={seoDescription}
		locale={currentLang}
	/>

	<WebPageSchema
		slot="head"
		title={seoTitle}
		description={seoDescription}
		image={seoImage}
	/>

	<BreadcrumbSchema slot="head" items={breadcrumbs} />

	<section>
		<div
			class="hero-image bg-home"
			style={`background-image: url(${heroImage?.unpicUrl})`}
		>
			<div class="hero-image__overlay"></div>
			<div class="hero-image__info">
				<div class="hero-image__text hero-heading">
					<p tabindex="0">Soy Alazne</p>
					<h1>{page.hero.title}</h1>
				</div>
				{
					page?.hero?.links?.map((link) => (
						<a href="#contact" class="btn">
							{link.link.label}
						</a>
					))
				}
			</div>
		</div>
	</section>

	<section class="h-intro wrapper">
		<div class="paragraph u-margin-top-8">
			<h2 class="heading-secondary" tabindex="0">{page.layout[0].title}</h2>
			<RichText content={page.layout[0].richText} />
		</div>
		<div class="h-intro__img">
			<Image
				src={page.layout[1].media.unpicUrl}
				width={500}
				height={375}
				alt={page.layout[1].media.alt || ''}
				layout="constrained"
				priority={false}
				cdn="cloudinary"
			/>
		</div>
	</section>

	<section class="h-services wrapper">
		<p class="heading-title" tabindex="0">{page.layout[2].sectionTitle}</p>
		<h2 class="heading-secondary" tabindex="0">{page.layout[2].title}</h2>
		<div class="paragraph"><RichText content={page.layout[2].richText} /></div>
		<HomeServices services={page.layout[3].services} />
	</section>

	<section class="h-job">
		<div class="wrapper">
			<p class="heading-title" tabindex="0">{page.layout[4].sectionTitle}</p>
			<h2 class="heading-secondary" tabindex="0">{page.layout[4].title}</h2>
			<div class="paragraph animated">
				<RichText content={page.layout[4].richText} />
				<a href="#contact" class="btn btn-section animated cta-btn"
					>Ponte en contacto</a
				>
			</div>
		</div>
		<div class="h-job__img">
			<Image
				src={page.layout[5].media.unpicUrl}
				width={480}
				height={446.4}
				alt={page.layout[1].media.alt || ''}
				layout="constrained"
				priority={false}
				cdn="cloudinary"
			/>
		</div>
	</section>

	<Testimonials opinions={page.layout[6]} />
	<Sentences sentences={page.layout[7].sentences} />
	<ContactForm inputErrors={inputErrors} csrf={csrf} />
</Layout>

<style>
	.border-pink {
		border: 1px solid #ffc4c7;
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const options = { threshold: 0.05, rootMargin: '0px 0px -10% 0px' };
		const animatedItems = document.querySelectorAll('.animated-2');

		if (!('IntersectionObserver' in window)) {
			animatedItems.forEach((el) => el.classList.add('slide-in-right'));
			return;
		}

		const observer = new IntersectionObserver((entries, observer) => {
			entries.forEach((entry, index) => {
				if (entry.target instanceof HTMLElement) {
					if (
						entry.isIntersecting &&
						!entry.target.classList.contains('slide-in-right')
					) {
						entry.target.style.animationDelay = `${index * 100}ms`;
						entry.target.classList.add('slide-in-right');
						observer.unobserve(entry.target);
					}
				}
			});
		}, options);

		animatedItems.forEach((item) => observer.observe(item));
	});
</script>
