---
import type { languagesList } from '@/i18n/ui';
import { useTranslations } from '@/i18n/utils';
import { actions } from 'astro:actions';
import SuccessPopup from '../pop-ups/SuccessPopup.astro';

const currentLang = Astro.currentLocale || 'es';
const t = useTranslations(currentLang as keyof typeof languagesList);
const { inputErrors, csrf } = Astro.props;
---

<form
	id="serviceForm"
	class="h-contact__form"
	action={actions.sendContactEmail}
	method="POST"
	style="max-width: 45rem; margin-bottom: 0;"
>
	<div>
		<label for="serviceUsername">{t('form.label.nombre')}</label>
		<input type="text" id="serviceUsername" name="serviceUsername" />
		<span id="serviceNameError" style="color:#eb374d"
			>{inputErrors?.username}</span
		>
	</div>
	<div>
		<label for="telephone">{t('form.label.telf')}</label>
		<input type="tel" id="telephone" name="telephone" required />
		<span id="servicePhoneError" style="color:#eb374d"
			>{inputErrors?.phone}</span
		>
	</div>
	<div>
		<label for="serviceEmail">{t('form.label.email')}</label>
		<input type="email" id="serviceEmail" name="serviceEmail" required />
		<span id="serviceEmailError" style="color:#eb374d"
			>{inputErrors?.serviceEmail}</span
		>
	</div>

	<button
		type="submit"
		id="serviceBtn"
		class="btn btn-section animated"
		style="z-index: 0; margin-top: 1rem;"
		disabled
	>
		<span id="ServiceBtnText">Enviar</span>
		<span
			id="btn-loader"
			class="spinner"
			style="display: none; margin-left: 0.5rem;"></span>
	</button>

	<div class="h-contact__footer">
		<input
			id="serviceTerms"
			name="termsAccepted"
			type="checkbox"
			required
			aria-label="Aceptar terminos"
		/>
		<p style="font-size: 10px; margin-top: 1rem;">
			Todos los datos aportados por el usuario en este formulario NO tendrán
			persistencia en ninguna base de datos ni en ningún otro sistema de
			persistencia.
		</p>
		<span id="serviceTermsError" style="color:#eb374d"
			>{inputErrors?.termsAccepted}</span
		>
	</div>
	<!-- Cloudflare Turnstile -->
	<div
		class="cf-turnstile"
		data-sitekey={import.meta.env.TURNSTILE_SITE_KEY}
		data-theme="light"
		data-size="normal"
		data-callback="onSuccess"
	>
	</div>
	<!-- Honeypot -->
	<input type="text" name="company" style="display:none" />
	<input type="hidden" name="cfTurnstileToken" id="cfTurnstileToken" />
	<input
		type="hidden"
		name="service"
		id="serviceInput"
		value={Astro.props.service || ''}
	/>
	<input type="hidden" name="lang" id="idioma" value={currentLang} />
	<input type="hidden" id="csrf_token" name="csrf_token" value={csrf} />

	<SuccessPopup />
</form>

<script is:inline>
	const form = document.getElementById('serviceForm');
	const submitBtn = document.getElementById('serviceBtn');
	const lang = window.location.pathname.split('/')[1] || 'es';

	const messages = {
		es: {
			serviceNameRequired: 'El nombre es obligatorio',
			serviceNameInvalid: 'El nombre debe de tener al menos 2 caracteres',
			serviceNameLengthInvalid:
				'El nombre no debe de tener más de 50 caracteres',
			servicePhone: 'El número de teléfono es obligatorio',
			servicePhoneInvalid: 'Introduce un número de teléfono español válido',
			serviceTermsRequired: 'Debes aceptar los términos',
			serviceEmailRequired: 'El email es obligatorio',
			serviceEmailInvalid: 'Email no válido',
			sending: 'Enviando...',
		},
		eu: {
			serviceNameRequired: 'Izena derrigorrezkoa da',
			serviceNameInvalid: 'Izenak gutxienez 2 karaktere izan behar ditu',
			serviceNameLengthInvalid:
				'Izenak ezin ditu 50 karaktere baino gehiago izan.',
			servicePhone: 'Telefono zenbakia beharrezkoa da',
			servicePhoneInvalid: 'Baliozko telefono zenbaki bat sartu',
			serviceTermsRequired: 'Baldintzak onartu behar dituzu',
			serviceEmailRequired: 'Posta elektronikoa derrigorrezkoa da',
			serviceEmailInvalid: 'Posta elektronikoa ez da baliozkoa',
			sending: 'Bidaltzen...',
		},
	}[lang as 'es' | 'eu'];

	const fields = {
		username: {
			input: document.getElementById('serviceUsername'),
			error: document.getElementById('serviceNameError'),
			validate: (v) => {
				const len = v.length;
				if (v.trim() === '') return messages.serviceNameRequired;
				if (len <= 2) return messages.serviceNameInvalid;
				if (len > 50) return messages.serviceNameLengthInvalid;
				return true;
			},
		},
		telephone: {
			input: document.getElementById('telephone'),
			error: document.getElementById('servicePhoneError'),
			validate: (v) => {
				if (v.trim() === '') return messages.servicePhone;
				return /^(6|7|8|9)\d{8}$/.test(v.trim())
					? true
					: messages.servicePhoneInvalid;
			},
		},
		email: {
			input: document.getElementById('serviceEmail'),
			error: document.getElementById('serviceEmailError'),
			validate: (v) => {
				if (v.trim() === '') return messages.serviceEmailRequired;
				return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim())
					? true
					: messages.serviceEmailInvalid;
			},
		},
		terms: {
			input: document.getElementById('serviceTerms'),
			error: document.getElementById('serviceTermsError'),
			validate: (checked) => checked || messages.serviceTermsRequired,
		},
	};

	function validateAll() {
		let valid = true;
		Object.values(fields).forEach((f) => {
			const value =
				f.input.type === 'checkbox' ? f.input.checked : f.input.value;
			const result = f.validate(value);
			if (result !== true) {
				f.error.textContent = result;
				f.input.classList.add('invalid');
				f.input.setAttribute('aria-invalid', 'true');
				valid = false;
			} else {
				f.error.textContent = '';
				f.input.classList.remove('invalid');
				f.input.setAttribute('aria-invalid', 'false');
			}
		});
		if (submitBtn) submitBtn.disabled = !valid;
		return valid;
	}

	Object.values(fields).forEach((f) => {
		f.input.addEventListener('input', validateAll);
		f.input.addEventListener('change', validateAll);
		f.input.addEventListener('blur', validateAll);
	});

	form?.addEventListener('submit', (e) => {
		if (!validateAll()) {
			e.preventDefault();
		} else {
			if (submitBtn) {
				submitBtn.disabled = true;
				const loader = document.getElementById('btn-loader');
				const text = document.getElementById('ServiceBtnText');
				if (loader) loader.style.display = 'inline-block';
				if (text) text.textContent = messages.sending;
			}
		}
	});
</script>

<style>
	.spinner {
		width: 1rem;
		height: 1rem;
		border: 2px solid #fff;
		border-top: 2px solid transparent;
		border-radius: 50%;
		animation: spin 0.6s linear infinite;
		vertical-align: middle;
	}

	@keyframes spin {
		from {
			transform: rotate(0deg);
		}
		to {
			transform: rotate(360deg);
		}
	}
</style>
