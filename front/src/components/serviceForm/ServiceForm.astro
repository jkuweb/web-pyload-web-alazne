---
import type { languagesList } from '@/i18n/ui';
import { useTranslations } from '@/i18n/utils';
import { actions } from 'astro:actions';
import SuccessPopup from '../pop-ups/SuccessPopup.astro';

const currentLang = Astro.currentLocale || 'es';
const t = useTranslations(currentLang as keyof typeof languagesList);
const { inputErrors, csrf } = Astro.props;
const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
---

<form
	id="serviceForm"
	class="h-contact__form"
	action={actions.sendContactEmail}
	method="POST"
	style="max-width: 45rem; margin-bottom: 0;"
>
	<div>
		<label for="serviceUsername">{t('form.label.nombre')}</label>
		<input type="text" id="serviceUsername" name="serviceUsername" />
		<span id="serviceNameError" style="color:#eb374d"
			>{inputErrors?.username}</span
		>
	</div>
	<div>
		<label for="telephone">{t('form.label.telf')}</label>
		<input type="tel" id="telephone" name="telephone" required />
		<span id="servicePhoneError" style="color:#eb374d"
			>{inputErrors?.phone}</span
		>
	</div>
	<div>
		<label for="serviceEmail">{t('form.label.email')}</label>
		<input type="email" id="serviceEmail" name="serviceEmail" required />
		<span id="serviceEmailError" style="color:#eb374d"
			>{inputErrors?.serviceEmail}</span
		>
	</div>

	<button
		type="submit"
		id="serviceBtn"
		class="btn btn-section animated"
		style="z-index: 0; margin-top: 1rem;"
		disabled
	>
		<span id="ServiceBtnText">Enviar</span>
		<span
			id="btn-loader"
			class="spinner"
			style="display: none; margin-left: 0.5rem;"></span>
	</button>

	<div class="h-contact__footer">
		<input
			id="serviceTerms"
			name="termsAccepted"
			type="checkbox"
			required
			aria-label="Aceptar terminos"
		/>
		<p style="font-size: 10px; margin-top: 1rem;">
			Todos los datos aportados por el usuario en este formulario NO tendrán
			persistencia en ninguna base de datos ni en ningún otro sistema de
			persistencia.
		</p>
		<span id="serviceTermsError" style="color:#eb374d"
			>{inputErrors?.termsAccepted}</span
		>
	</div>
	<div
		class="cf-turnstile"
		data-sitekey={TURNSTILE_SITE_KEY}
		data-theme="light"
		data-size="normal"
		data-callback="onTurnstileSuccess"
		data-error-callback="onTurnstileError"
		data-expired-callback="onTurnstileExpired"
	>
	</div>
	<input type="text" name="company" style="display:none" />
	<input type="hidden" name="cfTurnstileToken" id="cfTurnstileToken" />
	<input
		type="hidden"
		name="service"
		id="serviceInput"
		value={Astro.props.service || ''}
	/>
	<input type="hidden" name="lang" id="idioma" value={currentLang} />
	<input type="hidden" id="csrf_token" name="csrf_token" value={csrf} />

	<SuccessPopup />
</form>

<script is:inline>
	const form = document.getElementById('serviceForm');
	const submitBtn = document.getElementById('serviceBtn');

	const fields = {
		username: {
			input: document.getElementById('serviceUsername'),
			error: document.getElementById('serviceNameError'),
			validate: (v) => {
				if (v.trim() === '') return 'El nombre es obligatorio';
				if (v.length <= 2)
					return 'El nombre debe de tener al menos 2 caracteres';
				if (v.length > 50)
					return 'El nombre no debe de tener más de 50 caracteres';
				return true;
			},
		},
		telephone: {
			input: document.getElementById('telephone'),
			error: document.getElementById('servicePhoneError'),
			validate: (v) => {
				if (v.trim() === '') return 'El número de teléfono es obligatorio';
				return /^(6|7|8|9)\d{8}$/.test(v.trim())
					? true
					: 'Introduce un número de teléfono español válido';
			},
		},
		email: {
			input: document.getElementById('serviceEmail'),
			error: document.getElementById('serviceEmailError'),
			validate: (v) => {
				if (v.trim() === '') return 'El email es obligatorio';
				return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.trim())
					? true
					: 'Email no válido';
			},
		},
		terms: {
			input: document.getElementById('serviceTerms'),
			error: document.getElementById('serviceTermsError'),
			validate: (checked) => checked || 'Debes aceptar los términos',
		},
	};

	function validateFields() {
		let valid = true;
		Object.values(fields).forEach((f) => {
			const value =
				f.input.type === 'checkbox' ? f.input.checked : f.input.value;
			const result = f.validate(value);
			if (result !== true) {
				f.error.textContent = result;
				f.input.classList.add('invalid');
				f.input.setAttribute('aria-invalid', 'true');
				valid = false;
			} else {
				f.error.textContent = '';
				f.input.classList.remove('invalid');
				f.input.setAttribute('aria-invalid', 'false');
			}
		});
		return valid;
	}

	function updateSubmitButton() {
		const tokenInput = document.getElementById('cfTurnstileToken');
		const fieldsValid = validateFields();
		const tokenValid = tokenInput && tokenInput.value.trim() !== '';
		if (submitBtn) submitBtn.disabled = !(fieldsValid && tokenValid);
	}

	Object.values(fields).forEach((f) => {
		f.input.addEventListener('input', updateSubmitButton);
		f.input.addEventListener('change', updateSubmitButton);
		f.input.addEventListener('blur', updateSubmitButton);
	});

	window.onTurnstileSuccess = function (token) {
		const tokenInput = document.getElementById('cfTurnstileToken');
		if (tokenInput) tokenInput.value = token;
		updateSubmitButton();
	};

	window.onTurnstileError = function () {
		const tokenInput = document.getElementById('cfTurnstileToken');
		if (tokenInput) tokenInput.value = '';
		updateSubmitButton();
	};

	window.onTurnstileExpired = function () {
		const tokenInput = document.getElementById('cfTurnstileToken');
		if (tokenInput) tokenInput.value = '';
		updateSubmitButton();
	};

	form.addEventListener('submit', function (e) {
		if (submitBtn.disabled) e.preventDefault();
	});
</script>

<style>
	.spinner {
		width: 1rem;
		height: 1rem;
		border: 2px solid #fff;
		border-top: 2px solid transparent;
		border-radius: 50%;
		animation: spin 0.6s linear infinite;
		vertical-align: middle;
	}

	@keyframes spin {
		from {
			transform: rotate(0deg);
		}
		to {
			transform: rotate(360deg);
		}
	}
</style>
