---
// import '@/styles/richtext.css';
import Image from '../image/Image.astro';

interface Props {
	content: any;
	className?: string;
}

const { content, className } = Astro.props;

const SITE =
	Astro.site?.toString() || import.meta.env.SITE || 'http://localhost:3000';

function RenderBlock(block: any) {
	const { blockType } = block.fields || {};

	switch (blockType) {
		case 'mediaBlock':
			return Image;
		default:
			return null;
	}
}

function lexicalToHTML(nodes: any[]): string {
	if (!Array.isArray(nodes)) return '';

	return nodes
		.map((node) => {
			switch (node.type) {
				case 'paragraph': {
					let className = '';

					if (node.format === 'center') className = 'text-center';
					if (node.format === 'right') className = 'text-right';
					if (node.format === 'left') className = 'text-left';
					if (node.format === 'justify') className = 'text-justify';

					return `<p class="${className}">${lexicalToHTML(node.children)}</p>`;
				}

				case 'heading': {
					const tag = node.tag || 'h2';
					return `<${tag}>${lexicalToHTML(node.children)}</${tag}>`;
				}

				case 'text': {
					let text = node.text || '';
					if (node.format) {
						if (node.format & 1) text = `<strong>${text}</strong>`;
						if (node.format & 2) text = `<em>${text}</em>`;
						if (node.format & 8) text = `<code>${text}</code>`;
						if (node.format & 16) text = `<u>${text}</u>`;
					}
					return text;
				}

				case 'link': {
					let url = '#';
					let download = false;

					if (
						node.fields?.linkType === 'internal' &&
						node.fields?.doc?.value?.url
					) {
						url = node.fields.doc.value.url;
						if (node.fields.doc.value.mimeType === 'application/pdf') {
							download = true;
						}
					} else if (node.fields?.url) {
						url = node.fields.url;
					} else if (node.url) {
						url = node.url;
					}

					const rel =
						node.fields?.rel?.join(' ') ||
						(node.fields?.newTab ? 'noopener noreferrer' : '');

					const target = node.fields?.newTab ? '_blank' : '';
					const downloadAttr = download ? 'download' : '';

					return `<a href="${url}" ${target && `target="${target}"`} ${rel && `rel="${rel}"`} ${downloadAttr}>${lexicalToHTML(
						node.children,
					)}</a>`;
				}

				case 'list': {
					const tag = node.tag === 'ol' ? 'ol' : 'ul';
					return `<${tag}>${lexicalToHTML(node.children)}</${tag}>`;
				}

				case 'listitem':
					return `<li>${lexicalToHTML(node.children)}</li>`;

				case 'quote':
					return `<blockquote>${lexicalToHTML(node.children)}</blockquote>`;

				case 'linebreak':
					return '<br />';

				case 'horizontalrule':
					return '<hr />';

				case 'upload': {
					const rawSrc = node.value?.url || node.fields?.url;
					if (!rawSrc) return '';

					const src = rawSrc.startsWith('http')
						? rawSrc
						: new URL(rawSrc, SITE).toString();

					const alt = node.value?.alt || node.fields?.alt || '';
					const width = node.value?.width || 800;
					const height = node.value?.height || 600;

					return `
            <img
              src="${src}"
              alt="${alt}"
              width="${width}"
              height="${height}"
              loading="lazy"
              decoding="async"
              class="mx-auto rounded-lg"
            />
          `;
				}

				case 'block':
					return '';

				default:
					return node.children ? lexicalToHTML(node.children) : '';
			}
		})
		.join('');
}

const nodes = content?.root?.children || [];
---

<div class={`richtext ${className || ''}`}>
	{
		nodes.map((node: any) => {
			if (node.type === 'block') {
				const BlockComponent = RenderBlock(node);
				const { fields } = node;

				if (!BlockComponent) {
					return (
						<div class="unknown-block">Unknown block: {node.blockType}</div>
					);
				}

				return <BlockComponent {...fields} />;
			}

			return <Fragment set:html={lexicalToHTML([node])} />;
		})
	}
</div>
